# EigenTrust Protocol

This crate is an implementation of the EigenTrust Protocol. It's intended use is either as a library for other implementations or as a standalone implementation.

## Requirements

- Rust: To install, follow the instructions found [here](https://www.rust-lang.org/tools/install).
- Solidity Compiler: To install, follow the instructions found [here](https://docs.soliditylang.org/en/v0.8.9/installing-solidity.html).
- Anvil: CLI tool for running a local EVM blockchain. Follow these steps to install Anvil from source:

```bash
git clone https://github.com/foundry-rs/foundry
cd foundry
cargo install --path ./anvil --bins --locked --force
```

## Getting Started

If you want to use a local EVM blockchain, the first step is to spin up Anvil by running the `anvil` command:

```bash
anvil
```

Otherwise you should configure the `node_url` data field of the `client-config.json` file in the `data` directory to point to the correct Ethereum node. There's more about this in the configuration section.

Open a new terminal to start interacting with the client through the CLI. The first step is to compile and deploy the contracts. This is done by running the following commands:

```bash
cd ../client
cargo run --release -- compile-contracts
cargo run --release -- deploy-contracts
```

The next step is submitting attestations. The attestation data is also stored in the `client-config.json`

```bash
cargo run --release -- attest
```

It's now possible to calculate the global scores and generate a proof. This is done by running the `generate-proofs` command:

```bash
cargo run --release -- generate-proofs
```

This command will generate a proof and store it in the `data` directory. The final step is to verify it running the `verify` command:

```bash
cargo run --release -- verify
```

## CLI

The client's command-line interface was built using [clap.rs](http://clap.rs/). It provides the following command options:

- `attest`: Takes `ops` from the `client-config.json` file, signs it using `secret_key`, and submits it to the AttestationStation smart contract.
- `compile-contracts`: Compiles all the `.sol` and `.yul` contracts available in the `data` folder. For `.sol` contracts, it generates an ABI JSON file and a Rust binding file. For `.yul` smart contracts, it compiles Yul code into binary.
- `deploy-contracts`: Deploys all the contracts.
- `generate-proofs`: Calculates the global scores, generates the zk proof and stores it in `et-proof.json` at the `data` directory.
- `show`: Displays the `client-config.json` file.
- `update`: Updates the specified field in `client-config.json`. The argument must be passed as `[subcommand] "[new_value]"`. The available subcommands are:
    - `as_address`: Updates the address of the AttestationStation contract.
    - `mnemonic`: Updates the Ethereum wallet mnemonic phrase.
    - `score`: Updates a selected peer score. e.g. `score "Alice 100"`.
    - `node_url`: Updates the Ethereum node URL.
    - `sk`: Updates the secret_key. Both strings should be separated by a comma.
- `verify`: Verifies the latest zk proof generated by the `generate-proofs` command.

### Example of `update` command

```bash
cargo run --release -- update score "Alice 100"
```

## Configuration

### Client

The client configuration is stored in `data/client-config.json` and specifies the following parameters:

- `ops`: Contains the peer scores for the entire group, currently fixed at five members.
- `secret_key`: EdDSA secret key, is used to manage the EigenTrust sets.
- `as_address`: AttestationStation smart contract address. This is the contract that will receive the attestations.
- `et_verifier_wrapper_address`: Verifier smart contract for the EigenTrust global scores zk proof.
- `mnemonic`: Ethereum wallet mnemonic phrase.
- `node_url`: URL of the Ethereum node we are connecting to. The default is `127.0.0.1:8545` to work with a local `anvil` EVM blockchain.

It's possible to configure these parameters manually or using the `update` subcommand of the client CLI.
