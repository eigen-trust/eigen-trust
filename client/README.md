# EigenTrust Protocol

This crate is an implementation of the EigenTrust Protocol. It's intended use is either as a library for other implementations or as a standalone implementation.

## Requirements

- Rust: To install, follow the instructions found [here](https://www.rust-lang.org/tools/install).
- Solidity Compiler: To install, follow the instructions found [here](https://docs.soliditylang.org/en/v0.8.9/installing-solidity.html).
- Anvil: CLI tool for running a local EVM blockchain. Follow these steps to install Anvil from source:

```bash
git clone https://github.com/foundry-rs/foundry
cd foundry
cargo install --path ./anvil --bins --locked --force
```

## Getting Started

If you want to use a local EVM blockchain, the first step is to spin up Anvil by running the `anvil` command:

```bash
anvil
```

Otherwise you should configure the `node_url` data field of the `client-config.json` file in the `data` directory to point to the correct Ethereum node. There's more about this in the configuration section.

Open a new terminal to start interacting with the client through the CLI. The first step is to compile and deploy the contracts that the protocol is going to use to submit and verify the scores . This is done by running the following commands:

```bash
cd ../client
cargo run --release -- compile
cargo run --release -- deploy
```

The next step is submitting an attestation to a peer in the network. Attestations allow us to give a score to a peer and store that in the blockchain. This is done by running the `attest` command:

```bash
cargo run --release -- attest --to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 --score 5
```

It's now possible to fetch the peer-to-peer scores (from attestations), calculate the global scores and generate a proof. This is done by running the `proof` command:

```bash
cargo run --release -- proof
```

This command will generate a proof and store it in the `data` directory. The final step is to verify it using the `verify` command:

```bash
cargo run --release -- verify
```

## CLI

The command-line interface was built using [clap.rs](http://clap.rs/). There is a command description in the help menu, which can be opened passing `-h`. It also provides the following command options:

- `attest`: Submits an attestation. Takes the following options:
  - `--to`: Specify the attested address.
  - `--score`: Specify the given score (between 0 and 255).
  - `--message`: Specify an optional 32-byte message in hexadecimal format.
- `compile`: Compiles all the `.sol` and `.yul` contracts available in the `data` folder. For `.sol` contracts, it generates an ABI JSON file and a Rust binding file. For `.yul` smart contracts, it compiles Yul code into binary.
- `deploy`: Deploys all the contracts.
- `proof`: Calculates the global scores, generates the zk proof and stores it in `et-proof.json` at the `data` directory.
- `scores`: Calculates the global scores and stores them in the `scores.csv` file within the data directory.
- `show`: Displays the `client-config.json` file.
- `update`: Updates the specified field in `client-config.json`. Takes the following options:
  - `--as-address`: Updates the address of the AttestationStation contract.
  - `--domain`: Updates the domain identifier.
  - `--node`: Updates the Ethereum node URL.
  - `--verifier`: Updates the address of the Verifier smart contract for the EigenTrust global scores zk proof.
- `verify`: Verifies the latest zk proof generated by the `proof` command.

### Example of `update` command

```bash
cargo run --release -- update --node http://localhost:8545
```

### Example of `attest` command

```bash
cargo run --release -- attest --to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 --score 5 --message 0x473fe1d0de78c8f334d059013d902c13c8b53eb0f669caa9cad677ce1a601167
```

## Configuration

The configuration file is stored in `data/client-config.json`. You may need to update these parameters if, for example, the smart contracts are redeployed to new addresses or if you want to connect to a different Ethereum node. You can modify the following parameters:

- `as_address`: AttestationStation smart contract address. This is the contract that will receive the attestations.
- `mnemonic`: Ethereum wallet mnemonic phrase.
- `node_url`: URL of the Ethereum node we are connecting to. The default is `http://localhost:8545` to work with a local `anvil` EVM blockchain.
- `verifier_address`: Verifier smart contract for the EigenTrust global scores zk proof.

These parameters can also be modified using the `update` CLI command.

## Environment Configuration

You can customize some settings through environment variables:

- `MNEMONIC`: Your Ethereum wallet's mnemonic phrase.
- `BANDADA_API_KEY`: The Bandada API key.

We've provided a template for these variables in a file named `.env.origin`. You can create a copy of this file and rename it to `.env`:

```bash
cp .env.origin .env
```

Next, edit the `.env` file and replace the placeholder values with your actual ones:

```bash
MNEMONIC="your mnemonic phrase"
BANDADA_API_KEY="your bandada api key"
```

It's also possible to include _only_ the ones you want to override.
