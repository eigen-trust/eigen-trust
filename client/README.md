# EigenTrust Protocol

This crate is an implementation of the EigenTrust Protocol. It's intended use is either as a library for other implementations or as a standalone implementation.

## Requirements

- Rust: To install, follow the instructions found [here](https://www.rust-lang.org/tools/install).
- Solidity Compiler: To install, follow the instructions found [here](https://docs.soliditylang.org/en/v0.8.9/installing-solidity.html), or use the [Solidity Compiler Version Manager](https://github.com/alloy-rs/svm-rs):

```bash
cargo install svm-rs
svm install 0.8.17
```

- Anvil: CLI tool for running a local EVM blockchain. Follow these steps to install Anvil from source:

```bash
git clone https://github.com/foundry-rs/foundry
cd foundry
cargo install --path ./anvil --bins --locked --force
```

## Getting Started

If you want to use a local EVM blockchain, the first step is to spin up Anvil by running the `anvil` command:

```bash
anvil
```

Otherwise you should configure the `node_url` data field of the `client-config.json` file in the `data` directory to point to the correct Ethereum node. There's more about this in the configuration section.

Open a new terminal to start interacting with the client through the CLI. Let's build the release version of the client so we can run the program from the `target` directory:

```bash
cargo build --release
```

Once the project is built, we need to compile and deploy the contracts that the protocol is going to use to submit and verify the scores:

```bash
./target/release/eigen-trust-client compile
./target/release/eigen-trust-client deploy
```

The next step is submitting an attestation to a peer in the network. Attestations allow us to give a score to a peer and store that in the blockchain. This is done by running the `attest` command:

```bash
./target/release/eigen-trust-client attest --to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 --score 5
```

It's now possible to fetch the peer-to-peer scores (from attestations), calculate the global scores and generate a proof. This is done by running the `proof` command:

```bash
./target/release/eigen-trust-client proof
```

This command will generate a proof and store it in the `data` directory. The final step is to verify it using the `verify` command:

```bash
./target/release/eigen-trust-client verify
```

## CLI

The command-line interface was built using [clap.rs](http://clap.rs/). There is a command description in the help menu, which can be opened passing `-h`. It also provides the following command options:

- `attest`: Submits an attestation. Takes the following options:
  - `--to`: Specify the attested address.
  - `--score`: Specify the given score (between 0 and 255).
  - `--message`: Specify an optional 32-byte message in hexadecimal format.
- `bandada`: Used to manage Semaphore groups using the Bandada API. It is designed to either add participants to a group or remove them from it. Before executing this command, you should run the `scores` command to ensure having participants' scores, and to setup the `band-id` and `band-th` in the client configuration . Please note that when adding a participant, the command checks if their score is above the defined bandada group threshold, and only then proceeds with the addition. It requires the following options:
  - `--action (add | remove)`: Defines the action to perform. You can choose to `add` a new member to a group or `remove` an existing member from it.
  - `--ic`: Provides the identity commitment of the participant you intend to add or remove from the group.
  - `--addr`: Specifies the participant's Ethereum address.
- `compile`: Compiles all the `.sol` and `.yul` contracts available in the `data` folder. For `.sol` contracts, it generates an ABI JSON file and a Rust binding file. For `.yul` smart contracts, it compiles Yul code into binary.
- `deploy`: Deploys all the contracts.
- `proof`: Calculates the global scores, generates the zk proof and stores it in `et-proof.json` at the `data` directory.
- `scores`: Calculates the global scores and stores them in the `scores.csv` file within the data directory.
- `show`: Displays the `client-config.json` file.
- `update`: Updates the specified field in `client-config.json`. Takes the following options:
  - `--as-address`: Updates the address of the AttestationStation contract.
  - `--domain`: Updates the domain identifier.
  - `--band-id`: Updates the bandada group id.
  - `--band-th`: Updates the bandada group score threshold.
  - `--band-url`: Updates the bandada API endpoint.
  - `--node`: Updates the Ethereum node URL.
  - `--verifier`: Updates the address of the Verifier smart contract for the EigenTrust global scores zk proof.
- `verify`: Verifies the latest zk proof generated by the `proof` command.

### Example of `update` command

```bash
./target/release/eigen-trust-client update --node http://localhost:8545
```

### Example of `attest` command

```bash
./target/release/eigen-trust-client attest --to 0x70997970C51812dc3A010C7d01b50e0d17dc79C8 --score 5 --message 0x473fe1d0de78c8f334d059013d902c13c8b53eb0f669caa9cad677ce1a601167
```

### Example of `bandada` command

```bash
./target/release/eigen-trust-client scores # Can be skipped for testing, a scores.csv file is provided.
./target/release/eigen-trust-client update --band-id 51629751621128677209874422363557 --band-th 500
./target/release/eigen-trust-client bandada --action add --ic 82918723982 --addr 0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266
```

## Configuration

The configuration file is stored in `data/client-config.json`. You may need to update these parameters if, for example, the smart contracts are redeployed to new addresses or if you want to connect to a different Ethereum node. You can modify the following parameters:

- `as_address`: AttestationStation smart contract address. This is the contract that will receive the attestations.
- `mnemonic`: Ethereum wallet mnemonic phrase.
- `band_id`: Bandada group id.
- `band_th`: Bandada group score threshold. This is the minimum score required to be added to a bandada group.
- `band_url`: Bandada API endpoint.
- `node_url`: URL of the Ethereum node we are connecting to. The default is `http://localhost:8545` to work with a local `anvil` EVM blockchain.
- `verifier_address`: Verifier smart contract for the EigenTrust global scores zk proof.

These parameters can also be modified using the `update` CLI command.

## Environment Configuration

You can customize some settings through environment variables:

- `MNEMONIC`: Your Ethereum wallet's mnemonic phrase.
- `BANDADA_API_KEY`: The Bandada group API key.

We've provided a template for these variables in a file named `.env.origin`. You can create a copy of this file and rename it to `.env`:

```bash
cp .env.origin .env
```

Next, edit the `.env` file and replace the placeholder values with your actual ones:

```bash
MNEMONIC="your mnemonic phrase"
BANDADA_API_KEY="your bandada group api key"
```

It's also possible to include _only_ the ones you want to override.
